name: Update Blog Posts

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Update README with latest 23 blog posts
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=30" -o feed.xml

          cat > script.js <<'EOF'
          const fs = require('fs');
          const xml2js = require('xml2js');
          const parser = new xml2js.Parser();

          const data = fs.readFileSync('feed.xml', 'utf8');

          parser.parseString(data, (err, result) => {
            if (err) throw err;

            let html = "";

            const items = result.feed.entry || [];
            items.slice(0, 30).forEach(item => {
              const title = item.title[0]._;
              const url = item.link.find(l => l.$.rel === 'alternate').$.href;
              const date = new Date(item.published[0]).toLocaleDateString('en-GB');

              let img = "https://via.placeholder.com/150x150/333/fff?text=No+Image";
              if (item['media$thumbnail']?.[0]?.$?.url) {
                img = item['media$thumbnail'][0].$.url
                  .replace(/=s\d+(-c)?/g, '=s400')
                  .replace(/\/s\d+(-c)?\//g, '/s400/');
              }

              html += `<br/><a href="${url}"><img src="${img}" align="left" width="150" hspace="12" style="border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2)"/></a><a href="${url}"><b>${title}</b></a><br/><i>${date}</i><br clear="left"/><br/>\n`;
            });

            let readme = fs.readFileSync('README.md', 'utf8');
            const start = "<!-- BLOG-POST-LIST:START -->";
            const end   = "<!-- BLOG-POST-LIST:END -->";

            if (readme.includes(start) && readme.includes(end)) {
              readme = readme.replace(
                new RegExp(`${start}[\\s\\S]*?${end}`),
                `${start}\n${html.trim()}\n${end}`
              );
            } else {
              readme += `\n\n${start}\n${html.trim()}\n${end}`;
            }

            fs.writeFileSync('README.md', readme);
          });
          EOF

          npm install xml2js --no-save
          node script.js

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "Updated latest blog posts" && git push
