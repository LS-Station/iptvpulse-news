name: Update Latest Blog Posts

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update README with blog posts
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=30" -o feed.xml

          cat > generate.js << 'EOF'
          const fs = require('fs');
          const { parseStringPromise } = require('xml2js');

          (async () => {
            const xml = fs.readFileSync('feed.xml', 'utf8');
            const result = await parseStringPromise(xml);

            let output = "";

            const entries = result.feed.entry || [];
            for (const item of entries.slice(0, 30)) {
              const title = item.title[0]._;
              const link = item.link.find(l => l.$.rel === 'alternate').$.href;
              const date = new Date(item.published[0]).toLocaleDateString('en-GB', {
                day: 'numeric', month: 'short', year: 'numeric'
              });

              // থাম্বনেল ফিক্স – এবার সত্যিই ১০০% কাজ করবে
              let img = "https://via.placeholder.com/150x150.png?text=No+Image";
              if (item['media$thumbnail'] && item['media$thumbnail'][0] && item['media$thumbnail'][0].$.url) {
                img = item['media$thumbnail'][0].$.url
                  .replace(/=s\d+(-c)?/, '=s400')
                  .replace(/\/s\d+(-c)?\//, '/s400/');
              }

              output += `<br/>
          <a href="${link}">
            <img src="${img}" align="left" width="150" hspace="12" style="border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.2); margin-bottom:10px;">
          </a>
          <a href="${link}"><b>${title}</b></a><br/>
          <i>${date}</i><br clear="left"/><br/>\n`;
            }

            let readme = fs.readFileSync('README.md', 'utf8');

            const startMarker = "<!-- BLOG-POST-LIST:START -->";
            const endMarker   = "<!-- BLOG-POST-LIST:END -->";

            const startIndex = readme.indexOf(startMarker);
            const endIndex   = readme.indexOf(endMarker);

            if (startIndex !== -1 && endIndex !== -1) {
              const before = readme.slice(0, startIndex + startMarker.length);
              const after  = readme.slice(endIndex);
              fs.writeFileSync('README.md', before + "\n" + output.trim() + "\n" + after);
            } else {
              fs.appendFileSync('README.md', "\n\n" + startMarker + "\n" + output.trim() + "\n" + endMarker);
            }
          })();
          EOF

          npm install xml2js
          node generate.js

      - name: Commit & Push
        run: |
          git config user.name "Blog Bot"
          git config user.email "bot@github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "Updated latest blog posts" && git push
