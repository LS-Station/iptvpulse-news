name: Latest Blog Posts

on:
  schedule:
    - cron: '0 */6 * * *'   # প্রতি ৬ ঘণ্টায়
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch RSS & Generate Blog List
        run: |
          curl -s "https://iptvpulse.top/feeds/posts/default?alt=rss&max-results=20" -o feed.xml

          cat > generate.js << 'EOF'
          const fs = require('fs');
          const { parseString } = require('xml2js');

          const xml = fs.readFileSync('feed.xml', 'utf8');
          parseString(xml, (err, result) => {
            if (err) throw err;

            let output = "";

            const entries = result.feed.entry || [];
            entries.slice(0, 20).forEach(item => {
              const title = item.title[0]._;
              const link = item.link.find(l => l.$.rel === "alternate").$.href;
              const published = new Date(item.published[0]).toLocaleDateString('en-GB', {
                day: '2-digit', month: 'short', year: 'numeric'
              }).replace(/ /g, ' ');

              // থাম্বনেল বের করা – ১০০% কাজ করে
              let img = "https://via.placeholder.com/150x150/cccccc/666666?text=No+Image";
              if (item['media$thumbnail']) {
                img = item['media$thumbnail'][0].$.url
                  .replace(/\/s72-[a-z]+\//, '/s400/')
                  .replace(/=s72-[a-z]+$/, '=s400');
              }

              output += `<br/><a href="${link}"><img src="${img}" align="left" width="150" hspace="12" style="border-radius:10px; box-shadow: 0 4px 12px rgba(0,0,0,0.18);"/></a><a href="${link}"><b>${title}</b></a><br/><i>${published}</i><br clear="left"/><br/>\n`;
            });

            let readme = fs.readFileSync('README.md', 'utf8');
            const start = "<!-- BLOG-POST-LIST:START -->";
            const end   = "<!-- BLOG-POST-LIST:END -->";
            const regex = new RegExp(`${start}[\\s\\S]*?${end}`);
            const newContent = `${start}\n${output.trim()}\n${end}`;

            if (readme.match(regex)) {
              readme = readme.replace(regex, newContent);
            } else {
              readme += `\n\n${newContent}`;
            }

            fs.writeFileSync('README.md', readme);
          });
          EOF

          npm install xml2js
          node generate.js

      - name: Commit & Push changes
        run: |
          git config user.name "Blog Updater Bot"
          git config user.email "bot@github.com"
          git add README.md
          git diff --staged --quiet || (git commit -m "Updated latest blog posts with working images" && git push)
